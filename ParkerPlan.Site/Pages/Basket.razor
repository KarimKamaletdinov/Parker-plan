@page "/basket/"
@using ParkerPlan.QueryHandlers
@using ParkerPlan.Abstractions.Queries
@using ParkerPlan.Abstractions
@using ParkerPlan.Abstractions.Dtos
@using Newtonsoft.Json
@using ParkerPlan.Abstractions.Enums
@using Microsoft.AspNetCore.Http
@using System.Diagnostics.Eventing.Reader
@inject IQueryHandler<GetCostumers, CostumerDto[]> GetCostumers
@inject IQueryHandler<GetGoods, GoodDto[]> GetGoods
@inject IJSRuntime Js
@inject IHttpContextAccessor Context

<MudButton OnClick="WriteCookies">обновить куки</MudButton>
<MudButton OnClick="ReadCookies">Показать корзину</MudButton>

@if (_pens != null && _pens.Length > 0)
{
    <MudTable Items="@_pens">
        <HeaderContent>
            <MudTh>Наименование</MudTh>
            <MudTh>Код</MudTh>
            <MudTh>Кол-во</MudTh>
            <MudTh>Гравировка</MudTh>
        </HeaderContent>
        <RowTemplate>
            @{
                    var pen = GetGoods.Execute(new GetGoods()).First(x => x.ParkerId == context.GoodId);
            }
            <MudTd DataLabel="Наименование">@pen.Name</MudTd>
            <MudTd DataLabel="Код">@pen.ParkerId</MudTd>
            <MudTd DataLabel="Кол-во">
                <PlusMinusField Changed="i => { ChangeCount(pen.ParkerId, i); WriteCookies(); }"
                                MaxValue="100" MinValue="0" FieldValue="@context.Count"/>
            </MudTd>
            <MudTd DataLabel="Гравировка">    
                <StringInRowField Changed="i => { ChangeEng(pen.ParkerId, i); WriteCookies(); }"
                                  FieldValue="@context.Engraving"/>
                </MudTd>
        </RowTemplate>
    </MudTable>
}
else if (_pens != null)
{
    <MudText Align="Align.Center" Typo="Typo.h3">Корзина пуста</MudText>
}
else
{
    <MudText Align="Align.Center" Typo="Typo.h3">Нажмите"Показать корзину"</MudText>
}


@code
{
    private string JsonBasket { get; set; }

    private GoodLeadDto[] _pens;

    private void ChangeCount(int id, int val)
    {
        _pens.First(x => x.GoodId == id).Count = val;
    }

    private void ChangeEng(int id, string val)
    {
        _pens.First(x => x.GoodId == id).Engraving = val;
    }

    protected async Task WriteCookies()
    {
        await Js.InvokeAsync<object>("WriteCookie.WriteCookie", "basket", 
            JsonConvert.SerializeObject(_pens), DateTime.Now.AddYears(10));
    }
    protected async Task ReadCookies()
    {
        JsonBasket = await Js.InvokeAsync<string>("ReadCookie.ReadCookie", "basket");
        _pens = JsonConvert.DeserializeObject<GoodLeadDto[]>(JsonBasket);
    }
}
