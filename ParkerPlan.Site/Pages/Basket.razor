@page "/basket/"
@using ParkerPlan.QueryHandlers
@using ParkerPlan.Abstractions.Queries
@using ParkerPlan.Abstractions
@using ParkerPlan.Abstractions.Dtos
@using Newtonsoft.Json
@using ParkerPlan.Abstractions.Enums
@using System.Diagnostics.Eventing.Reader
@using System.Net
@using System.Threading
@using Microsoft.AspNetCore.Http
@using MudBlazor.Extensions
@using ParkerPlan.Site.Data
@inject IQueryHandler<GetCostumers, CostumerDto[]> GetCostumers
@inject IQueryHandler<GetGoods, GoodDto[]> GetGoods
@inject IJSRuntime Js
@inject IHttpContextAccessor Http
@inject PriceCalculatorService PriceCalculator
@*<MudButton OnClick="WriteCookies">обновить куки</MudButton>*@
@*<MudButton OnClick="ReadCookies">Показать корзину</MudButton>*@

@if (_pens != null && _pens.Length > 0)
{
    <MudText Align="Align.Center" Typo="Typo.h4">
        Ваш город: @_sity
        <CheckSity AutoInit="true" OnChanged="@((string value) => { _sity = value; })" />
    </MudText>
    <MudTable Items="@_pens">
        <HeaderContent>
            <MudTh>Наименование</MudTh>
            <MudTh>Код</MudTh>
            <MudTh>Кол-во</MudTh>
            <MudTh>Гравировка</MudTh>
            <MudTh>Стоимость</MudTh>
            <MudTh>Стоимость гравировки</MudTh>
            <MudTh>...</MudTh>
        </HeaderContent>
        <RowTemplate>
            @{
                    var pen = GetGoods.Execute(new GetGoods()).First(x => x.ParkerId == context.GoodId);

                    if (GetCount(pen.ParkerId) < 1)
                    {
                        context.Count = 0;
                    }
            }
            <MudTd DataLabel="Наименование">@pen.Name</MudTd>
            <MudTd DataLabel="Код">@pen.ParkerId</MudTd>
            <MudTd DataLabel="Кол-во">
                <PlusMinusField Changed="i => { ChangeCount(context.Id, i); WriteCookies(); }"
                                MaxValue="@GetCount(pen.ParkerId)" MinValue="1"
                                FieldValue="GetCount(pen.ParkerId) > 0 ? context.Count : 0"
                                Enabled="@(GetCount(pen.ParkerId) > 0)" />
            </MudTd>
            <MudTd DataLabel="Гравировка">
                <StringInRowField Changed="i => { ChangeEng(context.Id, i); WriteCookies(); }"
                                  FieldValue="@context.Engraving" Enabled="@(pen.AbleToEngraving)" />
            </MudTd>
            <MudTd DataLabel="Стоимость">@(pen.Price * context.Count) </MudTd>
            <MudTd DataLabel="Стоимость гравировки">
                @(string.IsNullOrEmpty(context.Engraving) ? "-" :
                                                        PriceCalculator.GetEngravingPrice() *
                                                        context.Count)
            </MudTd>
            <MudTd DataLabel="...">
                @{
                        var deleteIcon = Icons.Material.Filled.Delete;
                        var makeDoubleIcon = Icons.Material.Filled.ExposurePlus1;
                }
                <MudIconButton Icon="@deleteIcon" OnClick="() => { Delete(context.Id); }" />
                <MudIconButton Icon="@makeDoubleIcon" OnClick="() => { MakeDouble(context.Id); }" />
            </MudTd>
        </RowTemplate>
    </MudTable>

    <MudPaper Elevation="2" Class="pa-4">
        <FieldRow FieldName="Итого:" FieldValue="@(CalcSumm() + " руб.")" />
    </MudPaper>

    <MudPaper Elevation="2" Class="pa-4">
        <MudButton Link="/order/">Оформить заказ</MudButton>
    </MudPaper>
}
else
{
    <MudText Align="Align.Center" Typo="Typo.h3">Корзина пуста</MudText>
}
@*else if (_finished)
    {
        _pens = new BasketItem[0];
        WriteCookies();
    }
    else
    {
        <MudText Align="Align.Center" Typo="Typo.h3">
            Загрузка
        </MudText>

        <MudText Align="Align.Center" Typo="Typo.h3">
            <MudProgressCircular Color="Color.Info" Indeterminate="true" />
        </MudText>

                            //if (_startTime.AddSeconds(1) > DateTime.Now)
                            //{
                            //    Thread.Sleep(100);
                            //    StateHasChanged();
                            //}
                            //else
                            //{
                            //    _finished = true;
                            //    StateHasChanged();
                            //}
                        }*@


@code
{
    private string _sity = "";

    private string JsonBasket { get; set; }

    private BasketItem[] _pens;

    private bool _finished;

    private DateTime _startTime;

    protected override void OnInitialized()
    {
        ReadCookies();

        base.OnInitialized();
    }

    private void ChangeCount(int id, int val)
    {
        _pens.First(x => x.Id == id).Count = val;
    }

    private void ChangeEng(int id, string val)
    {
        _pens.First(x => x.Id == id).Engraving = val;
    }

    private int CalcSumm()
    {
        return PriceCalculator.CalculateFullPrice(_pens.Select(
            x => new GoodLeadDto
            {
                Count = x.Count,
                Engraving = x.Engraving,
                GoodId = x.GoodId
            }).ToArray());
    }

    private int GetCount(int penId)
    {
        var pen = GetGoods.Execute(new GetGoods()).First(x => x.ParkerId == penId);
        switch (_sity)
        {
            case "Москва":
                return pen.InMsk;
            case "Санкт-Петербург":
                return pen.InSpb;
            case "Уфа":
                return pen.InUfa;
            case "Екатеринбург":
                return pen.InEkt;
            case "Другой":
                return pen.InMsk + pen.InSpb + pen.InEkt + pen.InUfa;
        }
        return 0;
    }

    protected async Task WriteCookies()
    {
        await Js.InvokeAsync<object>("WriteCookie.WriteCookie", "basket",
            JsonConvert.SerializeObject(_pens), DateTime.Now.AddYears(10));
    }

    protected async Task ReadCookies()
    {
        JsonBasket = await Js.InvokeAsync<string>("ReadCookie.ReadCookie", "basket");
        _pens = JsonConvert.DeserializeObject<BasketItem[]>(
            await Js.InvokeAsync<string>("ReadCookie.ReadCookie", "basket"));
        var sity = (await Js.InvokeAsync<string>("ReadCookie.ReadCookie", "sity")).ToLower();

        if (sity == "moscow")
        {
            _sity = "Москва";
        }
        else if (sity == "stpeterburg")
        {
            _sity = "Санкт-Петербург";
        }
        else if (sity == "ufa")
        {
            _sity = "Уфа";
        }
        else if (sity == "ekaterinburg")
        {
            _sity = "Екатеринбург";
        }
        else if (sity == "another")
        {
            _sity = "Другой";
        }
        else
        {
            _sity = "Другой";
        }
    //if (JsonBasket == null)
        //{
        //    JsonBasket = Http.HttpContext.Request.Cookies["basket"];
        //    _pens = JsonConvert.DeserializeObject<BasketItem[]>(Http.HttpContext.Request.Cookies["basket"]);
        //}
        //if (_sity == null)
        //{
        //    sity = Enum.Parse<Sity>(Http.HttpContext.Request.Cookies["sity"]);

        //    switch (sity)
        //    {
        //        case Sity.Mosсow:
        //            _sity = "Москва";
        //            break;
        //        case Sity.StPeterburg:
        //            _sity = "Санкт-Петербург";
        //            break;
        //        case Sity.Ufa:
        //            _sity = "Уфа";
        //            break;
        //        case Sity.Ekaterinburg:
        //            _sity = "Екатеринбург";
        //            break;
        //        case Sity.Another:
        //            _sity = "Другой";
        //            break;
        //        default:
        //            _sity = "Другой";
        //            break;
        //    }
        //}
        //_finished = true;

        StateHasChanged();
    }

    private void Delete(int id)
    {
        var pens = _pens.ToList();
        pens.Remove(pens.Find(x => x.Id == id));
        _pens = pens.ToArray();
        WriteCookies();
    }

    private void MakeDouble(int id)
    {
        int Check()
        {
            var i = 0;

            while (_pens.Any(x => x.Id == i))
            {
                i++;
            }

            return i;
        }

        var pens = _pens.ToList();
        var pen = pens.Find(x => x.Id == id);
        pens.Add(new BasketItem
        {
            Count = pen.Count,
            Engraving = pen.Engraving,
            GoodId = pen.GoodId,
            Id = Check()
        });
        _pens = pens.ToArray();
        WriteCookies();
    }
}

