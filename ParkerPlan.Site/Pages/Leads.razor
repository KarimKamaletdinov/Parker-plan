@page "/leads/"
@using ParkerPlan.Abstractions
@using ParkerPlan.Abstractions.Dtos
@using ParkerPlan.Abstractions.Queries
@using ParkerPlan.Site.Data
@using Newtonsoft.Json
@inject IQueryHandler<GetLeads, LeadDto[]> GetLeads
@inject IQueryHandler<GetWorkers, WorkerDto[]> GetWorkers
@inject IJSRuntime Js

<MudSelect Value="_value" ValueChanged="(string s) => _value = s">
    <MudSelectItem Value="@("Только текущие")" />
    <MudSelectItem Value="@("Все")" />
</MudSelect>

@if (_login != null)
{
    @if (GetWorkers.Execute(new GetWorkers()).Any(x => x.Login == _login))
    {
        @if (_password == GetWorkers.Execute(new GetWorkers()).First(x => x.Login == _login).Password)
        {
            <MudTable Items="@GetLeads.Execute(new GetLeads())" Filter="Filter">
                <HeaderContent>
                    <MudTh>Имя получателя</MudTh>
                    <MudTh>Телефон</MudTh>
                    <MudTh>Дата доставки</MudTh>
                    <MudTh>Стоимость</MudTh>
                    <MudTh>...</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Имя получателя">@context.CustomerName</MudTd>
                    <MudTd DataLabel="Телефон">@context.CustomerPhone</MudTd>
                    <MudTd DataLabel="Дата доставки">@context.DeliveryDate.ToLongDateString()</MudTd>
                    <MudTd DataLabel="Стоимость">@context.FullPrice</MudTd>
                    <MudTd DataLabel="...">
                        <MudButton Link="@($"/lead/{context.Id}/")"
                                   StartIcon="@(Icons.Material.Rounded.MoreHoriz)"/>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
        else
        {
            <MudText Align="Align.Center" Typo="Typo.h3" Color="Color.Error">
                Неверное имя пользователя или пароль!!!
            </MudText>
        }
    }
    else
    {
        <MudText Align="Align.Center" Typo="Typo.h3" Color="Color.Error">
            Неверное имя пользователя или пароль!!!
        </MudText>
    }
}
else
{
    <MudText Align="Align.Center" Typo="Typo.h3">
        Загрузка
    </MudText>

    <MudText Align="Align.Center" Typo="Typo.h3">
        <MudProgressCircular Color="Color.Info" Indeterminate="true" />
    </MudText>
}

@code
{
    private string _login;

    private string _password;

    private string _value;

    protected override void OnInitialized()
    {
        ReadCookies();

        base.OnInitialized();
    }


    protected async Task ReadCookies()
    {
        _login = await Js.InvokeAsync<string>("ReadCookie.ReadCookie", "login");
        _password = await Js.InvokeAsync<string>("ReadCookie.ReadCookie", "password");
        StateHasChanged();
    }

    private bool Filter(LeadDto arg)
    {
        if (_value == "Только текущие")
        {
            return !arg.Delivered || !arg.Payed;
        }

        return true;
    }
}
