@page "/pen/{Id:int}"
@using ParkerPlan.Abstractions.Queries
@using ParkerPlan.Abstractions.Dtos
@using ParkerPlan.Abstractions
@using ParkerPlan.Abstractions.Enums
@using Microsoft.AspNetCore.Http
@using Newtonsoft.Json
@using ParkerPlan.Site.Data
@inject IJSRuntime Js
@inject IQueryHandler<GetGoods, GoodDto[]> GetGoods
@inject PasswordService Service
@inject IHttpContextAccessor Http

@{
    _good = GetGoods.Execute(new GetGoods()).First(x => x.ParkerId == Id);
}
<MudContainer Class="mt-16 px-8" MaxWidth="MaxWidth.False">
    @{
        var imgUrl = $"pens/PEN{_good.ParkerId}.bmp";
    }
    <MudGrid>
        <MudItem xs="6">
            <MudPaper Elevation="2" Class="pa-4">
                <img src=@imgUrl />
            </MudPaper>
        </MudItem>
        <MudItem xs="6">
            <MudPaper Elevation="2" Class="pa-4">
                <MudText Typo="Typo.h3" Align="Align.Left">
                    @_good.Name
                </MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="6">
            <MudPaper Elevation="2" Class="pa-4">
                <MudText Typo="Typo.h5" Align="Align.Left">
                    @_good.Description
                </MudText>
            </MudPaper>
        </MudItem>
        <MudItem xs="6">
            <MudPaper Elevation="2" Class="pa-4">
                <MudButton OnClick="AddToBasket">Добавить в корзину</MudButton>
                @*<MudButton OnClick="DeleteFromBasket">Удалить из корзины</MudButton>*@
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>


<MudContainer Class="mt-16 px-8" MaxWidth="MaxWidth.False">
    <MudPaper Elevation="2" Class="pa-4">
        @{
            var wnt = _good.WritingNodeType switch
            {
                WritingNodeType.Pen => "перьевой",
                WritingNodeType.Roller => "роллер",
                WritingNodeType.Round => "шариковый",
                _ => ""
            };

            var d = _good.GoldDetails ? "золотые" : "серебряные";

            var p = _good.GoldPen ? "золотое" : "серебряное";

            var e = _good.AbleToEngraving ? "да" : "нет";

            var m = _good.AbleForMan ? "да" : "нет";

            var w = _good.AbleForWoman ? "да" : "нет";
        }

        <FieldRow FieldName="Наименование" FieldValue=@_good.Name></FieldRow>
        <FieldRow FieldName="Цена" FieldValue=@_good.Price.ToString()></FieldRow>
        <FieldRow FieldName="Коллекция" FieldValue=@_good.Collection></FieldRow>
        <FieldRow FieldName="Код" FieldValue=@_good.ParkerId.ToString()></FieldRow>
        <MudDivider />
        <FieldRow FieldName="Тип пишущего узла" FieldValue="@wnt"> </FieldRow>
        <FieldRow FieldName="Детали" FieldValue=@d></FieldRow>
        <FieldRow FieldName="Перо" FieldValue=@p></FieldRow>
        <FieldRow FieldName="Возможна гравировка" FieldValue=@e></FieldRow>
        <MudDivider />
        <FieldRow FieldName="Кол-во в Москве" FieldValue=@_good.InMsk.ToString()></FieldRow>
        <FieldRow FieldName="Кол-во в Санкт-Петербурге" FieldValue=@_good.InSpb.ToString()></FieldRow>
        <FieldRow FieldName="Кол-во в Уфе" FieldValue=@_good.InUfa.ToString()></FieldRow>
        <FieldRow FieldName="Кол-во в Екатеринбурге" FieldValue=@_good.InEkt.ToString()></FieldRow>
        <MudDivider />
        <FieldRow FieldName="Подходит для мужчин" FieldValue=@m></FieldRow>
        <FieldRow FieldName="Подходит для женщин" FieldValue=@w></FieldRow>
    </MudPaper>

    @*<MudPaper Elevation="2" Class="pa-4">
            <MudButton OnClick="() => _showDialog = true">
                Изменить
            </MudButton>
        </MudPaper>*@
</MudContainer>

@{
    var link = $"/pen/{Id}/change/{Service.GetPassword()}";
}
<AdminDialog Visible="@_showDialog" CorrectPassword="@Service.GetPassword()" CloseMe="() => _showDialog = false"
             OkLink="@link" />

@code
{
    [ParameterAttribute]
    public int Id { get; set; }

    private GoodDto _good;

    private bool _showDialog;

    private async Task AddToBasket()
    {
        var basketStr = await Js.InvokeAsync<string>("ReadCookie.ReadCookie", "basket");

        var basket = JsonConvert.DeserializeObject<List<BasketItem>>(basketStr);

        var id = Check();

        int Check()
        {
            var i = 0;

            while (basket.Any(x => x.Id == i))
            {
                i++;
            }

            return i;
        }

        basket.Add(new BasketItem()
        {

            GoodId = _good.ParkerId,
            Engraving = null,
            Count = 1,
            Id = id
        });

        var newBasketStr = JsonConvert.SerializeObject(basket);

        await Js.InvokeAsync<object>("WriteCookie.WriteCookie", "basket", newBasketStr,
            DateTime.Now.AddYears(10).DayOfYear);

        Http.HttpContext.Request.Cookies.Append(new ("basket", newBasketStr));
    }

    private async Task DeleteFromBasket()
    {
        var basketStr = await Js.InvokeAsync<string>("ReadCookie.ReadCookie", "basket");

        var basket = JsonConvert.DeserializeObject<List<GoodLeadDto>>(basketStr);

        if (basket.Any(x => x.GoodId == _good.ParkerId))
        {
            basket.Remove(basket.Find(x => x.GoodId == _good.ParkerId));
        }

        var newBasketStr = JsonConvert.SerializeObject(basket);

        await Js.InvokeAsync<object>("WriteCookie.WriteCookie", "basket", newBasketStr,
            DateTime.Now.AddYears(10).DayOfYear);

        Http.HttpContext.Request.Cookies.Append(new ("basket", newBasketStr));
    }
}

